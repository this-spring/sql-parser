!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("util")):"function"==typeof define&&define.amd?define(["exports","util"],t):t((e=e||self).SQLParser={},e.util)}(this,function(e,t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;function s(e){console.log(a," Parser:",e);for(var t=[],r=u.UNKNOWN,n="",o="",s="",i="",l=0;l<e.length;l++){if("/"==(o=e.charAt(l))&&"*"==e.charAt(l+1)){for(n="",l++;++l<e.length;){if(s=e.charAt(l),i=e.charAt(l+1),"*"==s&&"/"==i){n=n.substr(0,n.length-1),l++;break}n+=""===n?s+i:i}t[t.length]={text:n.replace(/^[\*\s]+/,"").replace(/[\s\*]+$/,""),type:u.COMMENT}}else if("'"==o||'"'==o||"`"==o){for(n="";l<e.length&&o!=(s=e.charAt(++l));)console.log(s),n+="\\"==s?e.charAt(++l):s;t[t.length]={text:n,type:"`"==o?u.VARIABLE:u.STRING}}else if(":"==o){for(n=o;l<e.length&&(s=e.charAt(++l),/^\w+$/i.test(s));)n+=s;l--,t[t.length]={text:n,type:u.PARAMS}}else if(/^[a-z_]+$/i.test(o)){for(n=o;l<e.length&&(s=e.charAt(++l),/^[\w\.:]+$/i.test(s));)n+=s;l--,t[t.length]={text:n,type:"("==s?u.FUNCTION:u.KEYWORD}}else if("-"==o&&u.VARIABLE!=r||/\d+/.test(o)){for(n=o;l<e.length&&(s=e.charAt(++l),/^[\d\.]+$/.test(s));)n+=s;l--,t[t.length]="-"==n?{text:"-",type:u.OPERATOR}:{text:+n,type:u.NUMBER}}else if(/^[\,;\(\)]+$/.test(o))t[t.length]={text:o,type:u.COMMAS};else if(/^(\+|\-|\*|\/|>|<|=|!)$/.test(o)){for(n=o;l<e.length&&(s=e.charAt(++l),/^(\+|\*|\/|>|<|=|!)+$/.test(s));)n+=s;l--,t[t.length]={text:n,type:u.OPERATOR}}r=0===t.length?r:t[t.length-1].type}return t}var a="lexter",u={UNKNOWN:0,KEYWORD:1,NUMBER:2,STRING:3,FUNCTION:4,VARIABLE:5,PARAMS:6,OPERATOR:7,COMMAS:8,MEMORY:9,COMMENT:99};s("SELECT /*/ /** 我是注释 **/ 123, /** 456 **/`password`, MD5(\"123456\") FROM mysql.user WHERE host!='%'");function h(e){this.tokens=e instanceof Array?e:s(e.toString()),console.log(a,this.tokens),this.blocks=[];for(var t=0,r={"(":1,")":-1},n=0;n<this.tokens.length;++n){var o=this.tokens[n];o.type==u.COMMAS&&void 0!==r[o.text]?t+=r[o.text]:t||(this.blocks[this.blocks.length]=n)}}h.prototype.getAll=function(){return this.tokens},h.prototype.indexOf=function(t,e){var r=0,n=null;try{var o=new RegExp(t.text,"i")}catch(e){o=t.text.toLowerCase()}e=null==e?0:e+1;for(var s=0;s<this.blocks.length;++s)if(!((r=this.blocks[s])<e)&&(n=this.tokens[r],t.type==n.type&&(o instanceof RegExp&&o.test(n.text)||o==n.text.toLowerCase())))return this.blocks[s];return-1};var p={vars:function(e,t,r){var n;r&&(t=new h(t).getAll());if(!t[e])return null;switch(t[e].type){case u.OPERATOR:n=[t[e-1],t[e+1]];break;case u.FUNCTION:n=[];for(var o=[],s=0,i=e+1,l=t.length;i<l;i++){var a=t[i];if(a.type==u.COMMAS)switch(a.text){case"(":0<s&&o.push(a),s++;break;case")":if(0==--s){n.push(o),o=[],i=l;break}o.push(a);break;case",":1==s?(n.push(o),o=[]):o.push(a)}else o.push(a)}break;default:n=null}return n},text:function(e,t){var r=[];for(var n in e){var o=e[n];if(o&&o.type&&null!=o.text)switch(o.type){case u.STRING:r.push("'"+o.text+"'");break;case u.VARIABLE:default:r.push(o.text)}else r.push(null);t&&r.push(t)}return t&&r.pop(),r},types:u,create:function(e){return new h(e)}},n={"=":1,">":2,">=":3,"<":4,"<=":5,"<>":6,"!=":6,in:7,"not in":8,like:9,"not like":10,between:11,"is null":20,"not null":21};function l(e,t){t=void 0===t?" ":t;for(var r="",n=0;n<e.length;n++)r+=e[n].text+t;return r.substr(0,r.length-t.length)}function o(e,t){t=new RegExp(t,"i");var r=[],n=[];for(var o in e)t.test(e[o].text)?(r.push(n),n=[]):n.push(e[o]);return 0!==n.length&&r.push(n),r}var x={RELATE:n,ORDER:{ASC:1,DESC:2},JOIN:{"INNER JOIN":1,"OUTER JOIN":2,"LEFT JOIN":3,"RIGHT JOIN":4},removeParenthese:function e(t){if(void 0===t[0]||"("!==t[0].text)return t;for(var r=0,n=0;n<t.length;n++)"("===t[n].text&&r++,")"===t[n].text&&r--;if(0===r&&")"===t[t.length-1].text)return t.pop(),t.shift(),e(t);throw new Error("lack parenthese")},merge:l,pickUp:function(e,t){e.push({text:t});for(var r=[],n=0,o=0,s=0;s<e.length;s++)if("("===e[s].text&&o++,")"===e[s].text&&o--,new RegExp("^"+t+"$","i").test(e[s].text)&&0===o){var i=e.slice(n,s);if(0===i.length){n=s+1;continue}r.push(i),n=s+1}return r},getHint:function(e,t){var r=void 0;if(e&&e[t]&&e[t].type===p.types.COMMENT){r=e[t];for(var n=e.slice(0,t),o=0;o<=t;o++)e.shift();for(;0<n.length;)e.unshift(n.pop())}return r},parseOneSource:function(e){var t,r,n,o=e[0].text.indexOf(".");if(t=e[0].text.substr(0,o),-1===o)if("("===e[0].text){for(var s=1,i=1;i<e.length;i++)if("("===e[i].text&&s++,")"===e[i].text&&s--,0===s){r=l(e.slice(1,i)," "),e=e.slice(i+1,e.length);break}}else r=e[0].text,e.shift();else if(o===e[0].text.length-1){if("("!==e[1].text)throw new Error("something wrong in 'source' part");s=0;for(i=1;i<e.length;i++)if("("===e[i].text&&s++,")"===e[i].text&&s--,0===s){r=l(e.slice(2,i)," "),e=e.slice(i+1,e.length);break}if(i===e.length)throw new Error("lack parentheses in 'source' part")}else r=e[0].text.substr(o+1),e.shift();if(0===e.length)n={name:r,type:t,source:r};else{if(3<=e.length||2===e.length&&!/^as$/i.test(e[0].text)||e[e.length-1].type!==p.types.KEYWORD&&e[e.length-1].type!==p.types.VARIABLE)throw new Error("something wrong in 'source' part");n={name:e[e.length-1].text,type:t,source:r}}return n},parseOneWhere:function(e){var t={},r=e[1];if(t.column=e[0],r.type===p.types.OPERATOR){if(void 0===n[r.text])throw new Error("unrecognized operator");t.relate=n[r.text],t.values=o(e.slice(2),",")}else if("between"===r.text.toLowerCase())t.relate=n[r.text.toLowerCase()],t.values=o(e.slice(3,e.length-1),"and");else if("in"===r.text.toLowerCase())t.relate=n[r.text.toLowerCase()],t.values=o(e.slice(3,e.length-1),",");else if("like"===r.text.toLowerCase())t.relate=n[r.text.toLowerCase()],t.values=[[e[2]]];else if("is"===r.text.toLowerCase())if("not"===e[2].text.toLowerCase())t.relate=n["not null"],t.values=null;else{if("null"!==e[2].text.toLowerCase())throw new Error('wrong key word after "is"');t.relate=n["is null"],t.values=null}else{if("not"!==r.text.toLowerCase())throw new Error("unrecognized relate");if("in"===e[2].text.toLowerCase())t.relate=n["not in"],t.values=o(e.slice(4,e.length-1),",");else{if("like"!==e[2].text.toLowerCase())throw new Error('wrong key word after "not"');t.relate=n["not like"],t.values=[[e[3]]]}}return t}},c="select";function f(e){for(var t=[],r={},n=0,o=0;o<e.length;o++){var s=e[o].text,i=e[o].type;if("("!==s)if(")"!==s){if(0===n&&i===p.types.KEYWORD)if(/^SELECT$/i.test(s)){if(void 0!==r.column)continue;t.push({keyword:"column",pos:o}),r.column=!0}else if(/^FROM$/i.test(s)){if(void 0!==r.source)continue;t.push({keyword:"source",pos:o}),r.source=!0}else if(/^(JOIN|INNER|OUTER|LEFT|RIGHT)$/i.test(s)){if(void 0!==r.joinmap)continue;t.push({keyword:"joinmap",pos:o}),r.joinmap=!0}else if(/^WHERE$/i.test(s)){if(void 0!==r.where)continue;t.push({keyword:"where",pos:o}),r.where=!0}else if(/^GROUP$/i.test(s)){if(void 0!==r.groupby)continue;t.push({keyword:"groupby",pos:o}),r.groupby=!0}else if(/^ORDER$/i.test(s)){if(void 0!==r.orderby)continue;t.push({keyword:"orderby",pos:o}),r.orderby=!0}else if(/^LIMIT$/i.test(s)){if(void 0!==r.limit)continue;t.push({keyword:"limit",pos:o}),r.limit=!0}}else n--;else n++}var l={};for(o=1;o<t.length;o++)l[t[o-1].keyword]=e.slice(t[o-1].pos,t[o].pos);return l[t[t.length-1].keyword]=e.slice(t[t.length-1].pos),l}function g(e){var t={},r=x.pickUp(e,",");r[0].shift();for(var n=0;n<r.length;n++){var o,s,i=r[n],l=null;/^(distinct|all|distinctrow)$/i.test(i[0].text)&&(i[0].text=i[0].text.toUpperCase(),l=i[0],i.shift()),i[i.length-1].type===p.types.KEYWORD||i[i.length-1].type===p.types.VARIABLE?-1===(s=i[i.length-1].text.indexOf("."))?(o=i[i.length-1].text,1===i.length?t[o]={dist:l,expr:i}:/^as$/i.test(i[i.length-2].text)?t[o]={dist:l,expr:i.slice(0,i.length-2)}:t[o]={dist:l,expr:i.slice(0,i.length-1)}):t[o=i[i.length-1].text.substr(s+1)]={dist:l,expr:i}:t[o=x.merge(i,"")]={dist:l,expr:i}}return t}function v(e){var t={},r=x.pickUp(e,",");r[0].shift();for(var n=0;n<r.length;n++){var o=x.parseOneSource(r[n]);t[o.name]={type:o.type,source:o.source}}return t}function w(e){for(var t={},r=x.pickUp(e,"JOIN"),n=void 0,o=0;o<r.length;o++){var s=r[o];if(1!==s.length){var i,l,a,u=void 0===n?"INNER JOIN":n+" JOIN";n=/^(LEFT|RIGHT|OUTER|INNER)$/i.test(s[s.length-1].text)?s.pop().text:void 0;for(var h=void 0,p=0;p<s.length;p++)if(/^on$/i.test(s[p].text)){h=p;var c=s.slice(0,p),f=x.parseOneSource(c);a=f.name,i=f.type,l=f.source;break}if(void 0===h)throw new Error("no keyword 'on' in join part");var g=[],v=h+1;s.push({text:"and",type:1});for(p=v;p<s.length;p++)if(/^and$/i.test(s[p].text)){var w=s.slice(v,p);g.push(x.parseOneWhere(w)),v=p+1}t[a]={type:i,source:l,method:x.JOIN[u.toUpperCase()],where:g}}else n=s[0].text.toUpperCase()}return t}function y(e){var t=[],r=x.pickUp(e,"and");return r[0].shift(),r.forEach(function(e){t.push(x.parseOneWhere(e))}),t}function E(e){var t=[],r=x.pickUp(e,",");return r[0].shift(),r[0].shift(),r.forEach(function(e){t.push(e)}),t}function d(e){var t=[],r=x.pickUp(e,",");r[0].shift(),r[0].shift();for(var n=0;n<r.length;n++){var o,s=r[n],i=s[s.length-1].text.toUpperCase();/^(ASC|DESC)$/i.test(i)?(o=x.ORDER[i],s.pop()):o=x.ORDER.ASC,0!==s.length&&t.push({type:o,expr:s})}return t}function O(e){var t=[],r=x.pickUp(e,",");r[0].shift();for(var n=0;n<r.length;n++){var o=r[n];if(2<=o.length)throw new Error("something wrong in 'limit' part");t.push(o[0])}return 1===t.length&&t.unshift({text:0,type:2}),t}var r={parseColumn:g,parseSource:v,parseJoinmap:w,parseWhere:y,parseGroupby:E,parseOrderby:d,parseLimit:O,createObj:function(e){var t=[],r=p.create(e).getAll();console.log(c," createObj:",r);var n=function(e){for(var t=[],r=0,n=0,o=0;o<e.length;o++){var s=e[o].text;"("!==s?")"!==s?0===r&&/^UNION$/i.test(s)&&e[o].type===p.types.KEYWORD&&(t.push(x.removeParenthese(e.slice(n,o))),n=o+1):r--:r++}return t.push(x.removeParenthese(e.slice(n))),t}(r);console.log(c," tokenGroups:",n);for(var o=0;o<n.length;o++){var s={},i=f(n[o]);console.log(c,"parts:",i);var l=x.getHint(i.column,1);l&&(s.hint=l),i.column&&(s.column=g(i.column)),i.source&&(s.source=v(i.source)),i.joinmap&&(s.joinmap=w(i.joinmap)),i.where&&(s.where=y(i.where)),i.groupby&&(s.groupby=E(i.groupby)),i.orderby&&(s.orderby=d(i.orderby)),i.limit&&(s.limit=O(i.limit)),t.push(s)}return console.log(c,"result:",t),t}};function R(e){if(!/^update$/i.test(e.shift().text))throw i,new Error("no keyword 'update'");var t=x.parseOneSource(e);return{name:t.name,type:t.type,source:t.source}}function m(e){var t=[],r=x.pickUp(e,",");return r[0].shift(),r.forEach(function(e){t.push(x.parseOneWhere(e))}),t}function k(e){var t=[],r=x.pickUp(e,"and");return r[0].shift(),r.forEach(function(e){t.push(x.parseOneWhere(e))}),t}var A={parseSource:R,parseColumn:m,parseWhere:k,createObj:function(e){var t={},r=function(e){for(var t={},r=0,n=0,o=0;o<e.length;o++){var s=e[o].text;if("("!==s)if(")"!==s){if(0===r&&e[o].type===p.types.KEYWORD)if(/^SET$/i.test(s)){if(o===e.length-1)throw new Error("empty after keyword 'set'");t.source=e.slice(0,o),n=o}else if(/^WHERE$/i.test(s)){if(o===e.length-1)throw new Error("empty after keyword 'where'");t.column=e.slice(n,o),n=o}}else r--;else r++}return t.where=e.slice(n),t}(p.create(e).getAll()),n=x.getHint(r.source,1);return n&&(t.hint=n),r.source&&(t.source=R(r.source)),r.column&&(t.column=m(r.column)),r.where&&(t.where=k(r.where)),t}};function b(e){if(!/^insert$/i.test(e.shift().text))throw new Error("no keyword 'insert'");if(!/^into$/i.test(e.shift().text))throw new Error("no keyword 'into'");var t,r=[];if("("===e[0].text||e[0].text.indexOf(".")===e[0].text.length-1&&"("===e[1].text){for(var n=0,o=0;o<e.length;o++)if("("===e[o].text&&n++,")"===e[o].text&&n--,"("===e[o].text&&1===n&&1<o){t=x.parseOneSource(e.slice(0,o));break}if(void 0===t&&0!==n)throw new Error("parentheses are not paired");void 0===t?t=x.parseOneSource(e):e=e.slice(o)}else t=x.parseOneSource([e[0]]),e.shift();if(0!==e.length){if("("!==e[0].text)throw new Error("something wrong after source name");var s=x.removeParenthese(e);for(o=0;o<s.length;o++)","!==s[o].text&&r.push(s[o])}return{name:t.name,type:t.type,source:t.source,column:r}}function N(e){var t=[];if(e.shift(),0===e.length)throw new Error("empty after keyword 'value'");for(var r=0,n=0,o=0;o<e.length;o++)if("("!==e[o].text)if(")"!==e[o].text){if(","===e[o].text&&0===r){var s=x.removeParenthese(e.slice(n,o));n=o+1;for(var i=[],l=0;l<s.length;l++)","!==s[l].text&&i.push(s[l]);t.push(i)}}else r--;else r++;for(s=x.removeParenthese(e.slice(n)),i=[],o=0;o<s.length;o++)","!==s[o].text&&i.push(s[o]);return t.push(i),t}var C={parseSource:b,parseValues:N,createObj:function(e){var t={},r=function(e){for(var t={},r=0,n=0;n<e.length;n++){var o=e[n].text;"("!==o?")"!==o?0===r&&e[n].type===p.types.KEYWORD&&/^VALUES$/i.test(o)&&(t.source=e.slice(0,n),t.values=e.slice(n)):r--:r++}return void 0===t.source&&(t.source=e),t}(p.create(e).getAll()),n=x.getHint(r.source,1);return n&&(t.hint=n),r.source&&(t.source=b(r.source)),r.values&&(t.values=N(r.values)),t}};function I(e){if(!/^delete$/i.test(e.shift().text))throw new Error("no keyword 'delete'");if(!/^from$/i.test(e.shift().text))throw new Error("no keyword 'from'");var t=x.parseOneSource(e);return{name:t.name,type:t.type,source:t.source}}function L(e){var t=[],r=x.pickUp(e,"and");return r[0].shift(),r.forEach(function(e){t.push(x.parseOneWhere(e))}),t}var S={parseSource:I,parseWhere:L,createObj:function(e){var t={},r=function(e){for(var t={},r=0,n=0;n<e.length;n++){var o=e[n].text;"("!==o?")"!==o?0===r&&e[n].type===p.types.KEYWORD&&/^WHERE$/i.test(o)&&(t.source=e.slice(0,n),t.where=e.slice(n)):r--:r++}return void 0===t.source&&(t.source=e),t}(p.create(e).getAll()),n=x.getHint(r.source,1);return n&&(t.hint=n),r.source&&(t.source=I(r.source)),r.where&&(t.where=L(r.where)),t}},$={};$.select=r,$.update=A,$.insert=C,$.delete=S;console.log(JSON.stringify(function(e){var t=(e=e.trim()).substr(0,e.indexOf(" ")).toLowerCase();if(console.log("--\x3e"+t),void 0===$[t])throw new Error("Unsupport sentence");return $[t].createObj(e)}('SELECT /*/ /** 我是注释 **/ 123, `password`, MD5("123456") FROM mysql.user WHERE user="测试\\"引号" AND host!=\'%')));var T=x.RELATE,U=x.JOIN,M=x.ORDER,W=p.types,D={RELATE:T,JOIN:U,ORDER:M,types:W};e.JOIN=U,e.ORDER=M,e.RELATE=T,e.default=D,e.types=W,Object.defineProperty(e,"__esModule",{value:!0})});
